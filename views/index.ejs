<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üëó <%= appTitle || 'Boutique Gerenciamento' %></title>
    <link rel="stylesheet" href="/css/styles.css"> 
</head>
<body>
    <nav class="navbar">
        <h1>Glamour Boutique</h1>
        <div class="navbar-actions">
            <button id="btnNovaColecao" class="btn btn-primary">+ Cole√ß√£o</button>
            <button id="btnNovaPeca" class="btn btn-success">+ Nova Pe√ßa</button>
            <button id="btnNovaVenda" class="btn btn-primary">+ Venda</button>
        </div>
    </nav>

    <div class="container">
        <aside class="sidebar">
            <h3>Menu</h3>
            <ul>
                <li><a href="#" onclick="showSection('pecas')" class="active">Cat√°logo de Pe√ßas</a></li>
                <li><a href="#" onclick="showSection('vendas')">Transa√ß√µes (Vendas)</a></li>
                <li><a href="#" onclick="showSection('colecoes')">Gerenciar Cole√ß√µes</a></li>
            </ul>
            
            <hr>
            <h3>Cole√ß√µes (Filtro)</h3>
            <ul>
                <li><a href="#" onclick="filterByColecao(null)">Todas as Pe√ßas</a></li>
                <% colecoes.forEach(col => { %>
                    <li><a href="#" onclick="filterByColecao('<%= col.id %>')"><%= col.nome %></a></li>
                <% }) %>
            </ul>
        </aside>

        <main class="main-content">
            
            <div id="secao-pecas" class="content-section active">
                <h2>Cat√°logo de Pe√ßas</h2>
                <div class="pecas-grid">
                    <% pecas.forEach(peca => { %>
                        <div class="card" data-colecao="<%= peca.colecaoId || '' %>">
                            <div class="card-image">
                                <% if (peca.imagem) { %>
                                    <img src="/uploads/<%= peca.imagem %>" alt="Imagem: <%= peca.nome %>">
                                <% } else { %>
                                    <img src="https://via.placeholder.com/250x200/cccccc/000000?text=Sem+Foto" alt="Sem imagem">
                                <% } %>
                            </div>
                            <div class="card-content">
                                <h3><%= peca.nome %></h3>
                                <p class="colecao">Cole√ß√£o: **<%= peca.colecao ? peca.colecao.nome : 'Sem Cole√ß√£o' %>**</p>
                                <p class="price">R$ <%= peca.precoBase.toFixed(2) %></p>
                                
                                <hr>
                                <h4>Estoque (Varia√ß√µes)</h4>
                                <ul>
                                    <% if (peca.variacoes && peca.variacoes.length > 0) { %>
                                        <% peca.variacoes.forEach(v => { %>
                                            <li><%= v.tamanho %> / <%= v.cor %>: **<%= v.estoque %>** un.</li>
                                        <% }) %>
                                    <% } else { %>
                                        <li>Nenhuma varia√ß√£o cadastrada.</li>
                                    <% } %>
                                </ul>

                                <div class="card-actions">
                                    <button class="btn btn-primary btn-sm" onclick="abrirModalVariacao('<%= peca.id %>')">+ SKU/Estoque</button>
                                    <button class="btn btn-secondary btn-sm" onclick="abrirModalEdicaoPeca('<%= peca.id %>')">Editar Pe√ßa</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                </div>
            </div>

            <div id="secao-vendas" class="content-section">
                <h2>Hist√≥rico de Vendas</h2>
                <p>Aqui voc√™ ver√° a tabela de vendas e o impacto no estoque.</p>
                <table id="tabelaVendas">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Pe√ßa Vendida</th>
                            <th>Varia√ß√£o</th>
                            <th>Quantidade</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

            <div id="secao-colecoes" class="content-section">
                <h2>Gerenciar Cole√ß√µes</h2>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Descri√ß√£o</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% colecoes.forEach(col => { %>
                            <tr>
                                <td><%= col.id %></td>
                                <td><%= col.nome %></td>
                                <td><%= col.descricao || '-' %></td>
                                <td>
                                    <a href="/colecao/delete/<%= col.id %>" 
                                        class="btn btn-danger btn-sm" 
                                        onclick="return confirm('Tem certeza que deseja remover a cole√ß√£o?')">
                                        Remover
                                    </a>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>

        </main>
    </div> <div id="modalNovaPeca" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="fecharModal('modalNovaPeca')">&times;</span>
            <h3>üëó Cadastrar Nova Pe√ßa de Moda</h3>
            <form action="/add" method="POST" enctype="multipart/form-data">
                <div class="form-group"><label for="nome">Nome da Pe√ßa:</label><input type="text" id="nome" name="nome" required></div>
                <div class="form-group"><label for="precoBase">Pre√ßo Base (R$):</label><input type="number" id="precoBase" name="precoBase" step="0.01" min="0" required></div>
                <div class="form-group">
                    <label for="colecaoId">Cole√ß√£o:</label>
                    <select id="colecaoId" name="colecaoId">
                        <option value="">-- Sem Cole√ß√£o --</option>
                        <% colecoes.forEach(col => { %>
                            <option value="<%= col.id %>"><%= col.nome %></option>
                        <% }) %>
                    </select>
                </div>
                <div class="form-group"><label for="imagem">Foto da Pe√ßa:</label><input type="file" id="imagem" name="imagem" accept="image/*"></div>
                <div class="form-actions"><button type="submit" class="btn btn-primary">Salvar Pe√ßa no Cat√°logo</button></div>
            </form>
        </div>
    </div>

    <div id="modalNovaColecao" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="fecharModal('modalNovaColecao')">&times;</span>
            <h3>üè∑Ô∏è Cadastrar Nova Cole√ß√£o</h3>
            <form action="/colecao/add" method="POST">
                <div class="form-group"><label for="nomeColecao">Nome da Cole√ß√£o:</label><input type="text" id="nomeColecao" name="nome" required></div>
                <div class="form-group"><label for="descricaoColecao">Descri√ß√£o (Opcional):</label><textarea id="descricaoColecao" name="descricao" rows="3"></textarea></div>
                <div class="form-actions"><button type="submit" class="btn btn-primary">Salvar Cole√ß√£o</button></div>
            </form>
        </div>
    </div>

    <div id="modalNovaVenda" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="fecharModal('modalNovaVenda')">&times;</span>
            <h3>üí∏ Registrar Venda e Baixa de Estoque</h3>
            <form id="formNovaVenda">
                <div class="form-group">
                    <label for="variacaoSelect">Pe√ßa (Varia√ß√£o - Tamanho/Cor/Estoque):</label>
                    <select id="variacaoSelect" name="variacaoId" required>
                        <option value="">-- Selecione a Varia√ß√£o (SKU) --</option>
                        <% pecas.forEach(peca => { %>
                            <% if (peca.variacoes && peca.variacoes.length > 0) { %>
                                <optgroup label="<%= peca.nome %> (R$ <%= peca.precoBase.toFixed(2) %>)">
                                    <% peca.variacoes.forEach(v => { %>
                                        <% if (v.estoque > 0) { %>
                                            <option value="<%= v.id %>" data-estoque="<%= v.estoque %>" 
                                                data-preco="<%= v.precoAjuste || peca.precoBase %>">
                                                <%= v.tamanho %> / <%= v.cor %> (Estoque: <%= v.estoque %>)
                                            </option>
                                        <% } %>
                                    <% }) %>
                                </optgroup>
                            <% } %>
                        <% }) %>
                    </select>
                    <small id="estoqueDisponivel" style="color: blue;"></small>
                </div>
                <div class="form-group">
                    <label for="quantidadeVenda">Quantidade:</label>
                    <input type="number" id="quantidadeVenda" name="quantidade" min="1" value="1" required>
                    <small style="color: red;">A quantidade deve ser menor ou igual ao estoque dispon√≠vel.</small>
                </div>
                <div class="form-group"><label for="clienteVenda">Cliente (Opcional):</label><input type="text" id="clienteVenda" name="cliente" placeholder="Nome do Cliente"></div>
                <div id="vendaMessage" style="margin-top: 15px; font-weight: bold;"></div>
                <div class="form-actions"><button type="submit" class="btn btn-primary">Registrar Venda e Dar Baixa</button></div>
            </form>
        </div>
    </div>
    
    <script>
        // --- FUN√á√ïES DE CONTROLE DE MODALS ---
        function abrirModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.style.display = 'block'; 
            }
        }

        function fecharModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.style.display = 'none';
            }
            // Limpar mensagens e inputs da venda ao fechar
            if (id === 'modalNovaVenda') {
                document.getElementById('formNovaVenda').reset();
                document.getElementById('vendaMessage').innerHTML = '';
                document.getElementById('estoqueDisponivel').innerHTML = '';
            }
        }
        
        // --- FUN√á√ïES DE CONTROLE DE SE√á√ïES E FILTROS ---
        function showSection(sectionId) {
            // Remove a classe 'active' de todas as se√ß√µes
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            // Adiciona a classe 'active' √† se√ß√£o desejada
            document.getElementById(`secao-${sectionId}`).classList.add('active');
            
            // Recarrega dados de vendas se a se√ß√£o for ativada
            if (sectionId === 'vendas') {
                carregarVendas();
            }
        }
        
        function filterByColecao(colecaoId) {
            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                if (colecaoId === null || card.dataset.colecao == colecaoId) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        // --- FUN√á√ÉO DE CARREGAMENTO DE VENDAS (AJAX) ---
        async function carregarVendas() {
            const tbody = document.querySelector('#tabelaVendas tbody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Carregando vendas...</td></tr>';

            try {
                const response = await fetch('/venda'); 
                const data = await response.json();
                
                tbody.innerHTML = '';
                if (data.vendas && data.vendas.length > 0) {
                    data.vendas.forEach(venda => {
                        const row = tbody.insertRow();
                        const dataVenda = new Date(venda.DataVenda).toLocaleDateString('pt-BR'); // Alterado para DataVenda (mai√∫sculo)
                        
                        // Garante que a peca e a variacao existam
                        const pecaNome = venda.Variacao && venda.Variacao.Peca ? venda.Variacao.Peca.nome : 'Pe√ßa Removida'; 
                        const variacao = venda.Variacao ? `${venda.Variacao.tamanho}/${venda.Variacao.cor}` : 'Varia√ß√£o Removida';
                        
                        row.innerHTML = `
                            <td>${dataVenda}</td>
                            <td>${pecaNome}</td>
                            <td>${variacao}</td>
                            <td>${venda.quantidade}</td>
                            <td>R$ ${venda.precoTotal.toFixed(2).replace('.', ',')}</td>
                        `;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhuma venda registrada.</td></tr>';
                }
            } catch (error) {
                console.error("Erro ao buscar vendas:", error);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">Falha ao carregar as vendas.</td></tr>';
            }
        }

        // --- L√ìGICA DE VENDA (AJAX) ---
        async function registrarVenda(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const jsonData = Object.fromEntries(formData.entries());
            const messageDiv = document.getElementById('vendaMessage');

            try {
                const response = await fetch('/venda/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(jsonData)
                });

                const data = await response.json();

                if (response.ok) {
                    messageDiv.style.color = 'green';
                    messageDiv.innerHTML = data.message;
                    form.reset();
                    setTimeout(() => { window.location.reload(); }, 1500); // Recarrega para atualizar estoque/cat√°logo
                } else {
                    messageDiv.style.color = 'red';
                    messageDiv.innerHTML = data.message || 'Erro ao processar a venda.';
                }

            } catch (error) {
                console.error('Erro na requisi√ß√£o de venda:', error);
                messageDiv.style.color = 'red';
                messageDiv.innerHTML = 'Erro de conex√£o com o servidor.';
            }
        }
        
        // --- L√ìGICA DE ATUALIZA√á√ÉO DO ESTOQUE NO SELECT ---
        function updateEstoqueInfo() {
            const select = document.getElementById('variacaoSelect');
            const estoqueInfo = document.getElementById('estoqueDisponivel');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption && selectedOption.dataset.estoque) {
                const estoque = selectedOption.dataset.estoque;
                const preco = parseFloat(selectedOption.dataset.preco).toFixed(2).replace('.', ',');
                estoqueInfo.innerHTML = `Dispon√≠vel: **${estoque}** unidades. Pre√ßo: R$ ${preco}.`;
                document.getElementById('quantidadeVenda').max = estoque; // Limita o input
            } else {
                estoqueInfo.innerHTML = '';
                document.getElementById('quantidadeVenda').max = '';
            }
        }


        // --- INICIALIZA√á√ÉO E LISTENER DE EVENTOS ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Inicia mostrando o Cat√°logo
            showSection('pecas'); 
            
            // 2. Liga os bot√µes de Modal (Navbar)
            document.getElementById('btnNovaPeca').addEventListener('click', () => { abrirModal('modalNovaPeca'); });
            document.getElementById('btnNovaColecao').addEventListener('click', () => { abrirModal('modalNovaColecao'); });
            document.getElementById('btnNovaVenda').addEventListener('click', () => { abrirModal('modalNovaVenda'); });

            // 3. Liga o formul√°rio de venda ao evento submit (AJAX)
            const formVenda = document.getElementById('formNovaVenda');
            if (formVenda) {
                formVenda.addEventListener('submit', registrarVenda);
            }
            
            // 4. Liga a atualiza√ß√£o de estoque ao mudar a varia√ß√£o
            const variacaoSelect = document.getElementById('variacaoSelect');
            if (variacaoSelect) {
                 variacaoSelect.addEventListener('change', updateEstoqueInfo);
            }

            // 5. Fechar modal clicando fora
            window.onclick = function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = "none";
                }
            }
        });
        
        // Fun√ß√µes placeholders para evitar erro no console ao clicar nos bot√µes do cart√£o de pe√ßa:
        function abrirModalVariacao(pecaId) { 
            alert('Funcionalidade em desenvolvimento: Abrir Modal para adicionar Varia√ß√£o/SKU na Pe√ßa ID: ' + pecaId);
            // Voc√™ precisar√° de um modal chamado 'modalVariacao' e a l√≥gica AJAX
        }
        function abrirModalEdicaoPeca(pecaId) { 
            alert('Funcionalidade em desenvolvimento: Abrir Modal de Edi√ß√£o para Pe√ßa ID: ' + pecaId);
            // Voc√™ precisar√° de um modal chamado 'modalEdicaoPeca' e a l√≥gica AJAX
        }
        
    </script>
</body>
</html>